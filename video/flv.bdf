// BinDef for the FLV multimedia format
// Produced from https://en.wikipedia.org/wiki/Flash_Video

{
  meta: {
    bdf: "0.3",
    name: "Flash Video (FLV) multimedia",
    mime: ["video/x-flv"],
    exts: [".flv"],
  },
  binary: [
    { id: header,
      type: struct,
      endian: "big",
      fields: [
        { type: magic,  match: "FLV" },
        { type: uint8,  id: version, name: "Version", valid: version == 0x01 },
        { type: uint8,  id: flags,   name: "Flags" },
        { type: uint32, id: size,    name: "Header size (bytes)" }
      ]
    },
    { id: packets,
      type: array[eos],
      name: "Packets",
      at: header.size,
      item: {
        name: "Packet",
        type: struct,
        endian: "big",
        fields: [
          { type: uint32,   id: prevPacketSize, name: "Size of previous packet (bytes)" },
          { type: uint8,    id: packetType,     name: "Packet type" },
          { type: array[3], id: _psb, item: { type: uint8 }},
          { type: var,      id: payloadSize,    name: "Payload size (bytes)",
            value: _psb[0]<<16 | _psb[1]<<8 | _psb[2] 
          },
          { type: uint32,   id: timestamp,      name: "Timestamp" },
          { type: array[3], id: _sib, item: { type: uint8 }},
          { type: var,      id: streamID,    name: "Stream ID",
            value: _sib[0]<<16 | _sib[1]<<8 | _sib[2] 
          },
          { type: byte[payloadSize], id: payload, name: "Payload data" }
        ]
      }
    }
  ]
}
